---
import "../styles/global.css";
const { content } = Astro.props;

// backend URL resolved at runtime
const BACKEND =
  (import.meta.env && import.meta.env.PUBLIC_BACKEND_URL) ||
  "http://10.5.60.251:3000";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{content.title}</title>

    <!-- ============================================
         SESSION GUARD (CLEAN + ONE SCRIPT ONLY)
         ============================================ -->
    <script is:inline>
      (function () {
        if (typeof window === "undefined") return;

        const PUBLIC = ["/", "/login", "/signup"];
        const path = location.pathname;

        // backend = dynamic LAN-safe URL
        const backend =
          window.location.protocol + "//" + window.location.hostname + ":3000";

        if (PUBLIC.some((p) => path.startsWith(p))) return;

        async function checkSession() {
          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 3000);

            const r = await fetch(backend + "/auth/me", {
              credentials: "include"
            });

            clearTimeout(timeout);

            if (!r.ok) {
              location.replace("/login");
            }
          } catch (err) {
            console.warn("[SESSION] network error:", err);
            location.replace("/login");
          }
        }

        checkSession();
      })();
    </script>

  </head>

  <body>
    <slot />
  </body>
</html>
